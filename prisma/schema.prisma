generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
  CONTRACTOR
  USER
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

enum JobType {
  IMMEDIATE
  SCHEDULED
  BIDDING
}

enum JobStatus {
  PENDING
  QUOTED
  ACCEPTED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DISPUTED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  COMPLETED
  FAILED
  REFUNDED
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum NotificationType {
  JOB_REQUEST
  QUOTE_RECEIVED
  JOB_ACCEPTED
  JOB_STARTED
  JOB_COMPLETED
  PAYMENT_RECEIVED
  LOCATION_UPDATE
  SYSTEM_ALERT
}

enum QuoteStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum MaterialsProvider {
  USER
  CONTRACTOR
}

enum PaymentType {
  ADVANCE
  FINAL
}

enum CommissionStatus {
  PENDING
  PROCESSED
  PAID
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id             String   @id @default(cuid())
  email          String?  @unique
  phone          String   @unique
  password       String?
  firstName      String
  lastName       String
  role           UserRole @default(USER)
  status         UserStatus @default(PENDING_VERIFICATION)
  profileImage   String?
  dateOfBirth    DateTime?
  address        String?
  city           String?
  state          String?
  pincode        String?
  latitude       Float?
  longitude      Float?
  isVerified     Boolean  @default(false)
  isGuest        Boolean  @default(false)
  lastLoginAt    DateTime?
  fcmToken       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  contractorProfile Contractor?
  jobsAsUser        Job[]          @relation("JobUser")
  reviewsGiven      Review[]       @relation("ReviewGiver")
  reviewsReceived   Review[]       @relation("ReviewReceiver")
  notifications     Notification[]
  payments          Payment[]
  documents         Document[]
  locationUpdates   LocationUpdate[]
  chatMessages      ChatMessage[]
  chatRooms         ChatRoom[]     @relation("ChatRoomParticipants")
  pushSubscriptions PushSubscription[]
  commissionsApproved Commission[] @relation("CommissionApprover")

  @@map("users")
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}

model Contractor {
  id                String   @id @default(cuid())
  userId            String   @unique
  businessName      String
  businessType      String
  gstNumber         String?
  panNumber         String?
  businessAddress   String
  businessCity      String
  businessState     String
  businessPincode   String
  businessLatitude  Float?
  businessLongitude Float?
  coverageRadius    Float    @default(20.0)
  isActive          Boolean  @default(true)
  rating            Float    @default(0.0)
  totalJobs         Int      @default(0)
  completedJobs     Int      @default(0)
  verificationStatus VerificationStatus @default(PENDING)
  bankAccountNumber String?
  bankIfscCode      String?
  bankAccountName   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workers   Worker[]
  rateCards RateCard[]
  jobs      Job[]    @relation("JobContractor")
  reviews   Review[] @relation("ContractorReview")
  quotes    Quote[]
  meetings  Meeting[]
  documents Document[]

  @@map("contractors")
}

model Worker {
  id            String   @id @default(cuid())
  contractorId  String
  firstName     String
  lastName      String
  phone         String
  email         String?
  profileImage  String?
  skills        String[]
  experience    Int?
  hourlyRate    Float?
  dailyRate     Float?
  isActive      Boolean  @default(true)
  isVerified    Boolean  @default(false)
  rating        Float    @default(0.0)
  totalJobs     Int      @default(0)
  completedJobs Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contractor   Contractor      @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  availability Availability[]
  jobAssignments JobAssignment[]
  documents      Document[]
  reviews        Review[]        @relation("WorkerReview")

  @@map("workers")
}

model RateCard {
  id            String   @id @default(cuid())
  contractorId  String
  skill         String
  minHours      Int      @default(1)
  hourlyRate    Float
  dailyRate     Float?
  travelCharges Float    @default(0.0)
  extraCharges  Float    @default(0.0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@map("rate_cards")
}

model Availability {
  id          String   @id @default(cuid())
  workerId    String
  date        DateTime @db.Date
  timeSlot    String?
  isAvailable Boolean  @default(true)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  worker Worker @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@unique([workerId, date, timeSlot])
  @@map("availability")
}

model Job {
  id                      String   @id @default(cuid())
  userId                  String
  contractorId            String?
  title                   String
  description             String
  jobType                 JobType
  status                  JobStatus @default(PENDING)
  address                 String
  city                    String
  state                   String
  pincode                 String
  latitude                Float
  longitude               Float
  workersNeeded           Int?
  scheduledStartDate      DateTime?
  detailedDescription     String?
  expectedDays            Int?
  startDate               DateTime?
  materialsProvidedBy     MaterialsProvider?
  siteVisitDeadline       DateTime?
  quoteSubmissionDeadline DateTime?
  scheduledDate           DateTime?
  scheduledTime           String?
  estimatedDuration       Int?
  numberOfWorkers         Int       @default(1)
  requiredSkills          String[]
  images                  String[]
  budget                  Float?
  acceptedQuote           Float?
  acceptedQuoteId         String?   @unique
  advancePaid             Float     @default(0.0)
  totalPaid               Float     @default(0.0)
  isLocationTracking      Boolean   @default(false)
  cancellationReason      String?
  cancelledBy             UserRole?
  locationSharingCode     String?
  locationSharingWorkerPhone String?
  locationSharingCodeExpiresAt DateTime?
  travelStatus            String?
  expiresAt               DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user            User        @relation("JobUser", fields: [userId], references: [id])
  contractor      Contractor? @relation("JobContractor", fields: [contractorId], references: [id])
  quotes          Quote[]
  acceptedQuoteRel Quote?     @relation("AcceptedQuote", fields: [acceptedQuoteId], references: [id])
  assignments     JobAssignment[]
  reviews         Review[]    @relation("JobReview")
  payments        Payment[]
  commissions     Commission[]
  locationUpdates LocationUpdate[]
  chatRoom        ChatRoom?
  meetings        Meeting[]

  @@map("jobs")
  @@index([status])
  @@index([jobType])
  @@index([latitude, longitude], name: "location_idx")
}

model Quote {
  id                 String      @id @default(cuid())
  jobId              String
  contractorId       String
  amount             Float
  totalAmount        Float?
  addOns             Json?
  documents          String[]
  meetingScheduledOn DateTime?
  status             QuoteStatus @default(PENDING)
  advanceRequested   Boolean     @default(false)
  advanceAmount      Float       @default(0)
  estimatedArrival   String?
  notes              String?
  isAccepted         Boolean     @default(false)
  expiresAt          DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  job        Job        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  contractor Contractor @relation(fields: [contractorId], references: [id])
  acceptedForJob Job?   @relation("AcceptedQuote")

  @@map("quotes")
}

model JobAssignment {
  id          String   @id @default(cuid())
  jobId       String
  workerId    String
  assignedAt  DateTime @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  status      String   @default("assigned")

  job    Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  worker Worker @relation(fields: [workerId], references: [id])

  @@unique([jobId, workerId])
  @@map("job_assignments")
}

model Review {
  id           String     @id @default(cuid())
  jobId        String
  giverId      String
  receiverId   String
  receiverType String
  rating       Int
  comment      String?
  createdAt    DateTime   @default(now())

  job        Job         @relation("JobReview", fields: [jobId], references: [id])
  giver      User        @relation("ReviewGiver", fields: [giverId], references: [id])
  receiver   User        @relation("ReviewReceiver", fields: [receiverId], references: [id], map: "review_receiver_user_fkey")
  contractor Contractor? @relation("ContractorReview", fields: [receiverId], references: [id], map: "review_receiver_contractor_fkey")
  worker     Worker?     @relation("WorkerReview", fields: [receiverId], references: [id], map: "review_receiver_worker_fkey")

  @@unique([jobId, giverId, receiverId])
  @@map("reviews")
}

model AdminSettings {
  id             String @id @default(cuid())
  commissionRate Float  @default(0.1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("admin_settings")
}

model Commission {
  id              String           @id @default(cuid())
  jobId           String
  paymentId       String
  amount          Float
  status          CommissionStatus @default(PENDING)
  approvalStatus  ApprovalStatus   @default(PENDING)
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  adminNotes      String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  job     Job     @relation(fields: [jobId], references: [id])
  payment Payment @relation(fields: [paymentId], references: [id])
  approver User?  @relation("CommissionApprover", fields: [approvedBy], references: [id])

  @@map("commissions")
}

model Payment {
  id              String        @id @default(cuid())
  jobId           String
  userId          String
  amount          Float
  paymentType     PaymentType
  status          PaymentStatus @default(PENDING)
  gateway         String?
  gatewayId       String?
  gatewayResponse Json?
  refundAmount    Float?        @default(0.0)
  refundReason    String?
  processedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  job  Job  @relation(fields: [jobId], references: [id])
  user User @relation(fields: [userId], references: [id])
  commissions Commission[]

  @@map("payments")
}

model Document {
  id                 String             @id @default(cuid())
  userId             String?
  contractorId       String?
  workerId           String?
  documentType       String
  documentNumber     String?
  documentUrl        String
  verificationStatus VerificationStatus @default(PENDING)
  verifiedAt         DateTime?
  verifiedBy         String?
  rejectionReason    String?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  user       User?        @relation(fields: [userId], references: [id])
  contractor Contractor?  @relation(fields: [contractorId], references: [id])
  worker     Worker?      @relation(fields: [workerId], references: [id])

  @@map("documents")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  sentAt    DateTime         @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model LocationUpdate {
  id        String   @id @default(cuid())
  userId    String
  jobId     String
  latitude  Float
  longitude Float
  accuracy  Float?
  timestamp DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  job  Job  @relation(fields: [jobId], references: [id])

  @@map("location_updates")
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

model Meeting {
  id           String        @id @default(cuid())
  jobId        String
  contractorId String
  meetingTime  DateTime
  location     String
  status       MeetingStatus @default(SCHEDULED)
  notes        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  job        Job        @relation(fields: [jobId], references: [id])
  contractor Contractor @relation(fields: [contractorId], references: [id])

  @@map("meetings")
}

model ChatRoom {
  id           String        @id @default(cuid())
  jobId        String        @unique
  job          Job           @relation(fields: [jobId], references: [id])
  participants User[]        @relation("ChatRoomParticipants")
  messages     ChatMessage[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("chat_rooms")
}

model ChatMessage {
  id         String   @id @default(cuid())
  chatRoomId String
  senderId   String
  message    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender   User     @relation(fields: [senderId], references: [id])

  @@map("chat_messages")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldValues  Json?
  newValues  Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@map("audit_logs")
}